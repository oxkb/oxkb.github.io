<!DOCTYPE html>
<html lang="am">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Online Amharic Keyboard (የአማርኛ ኪቦርድ) - Type Amharic Easily</title>

    <meta name="description" content="A free and easy-to-use online Amharic keyboard (Fidel keyboard) to type Amharic letters and characters directly in your browser. Supports physical keyboard input and virtual key selection. Ideal for typing Amharic on any device.">
    <meta name="keywords" content="Amharic keyboard, online Amharic keyboard, Fidel keyboard, type Amharic, አማርኛ ኪቦርድ, Ethiopian keyboard, Geez keyboard, free Amharic typing, Amharic letters, type Fidel, Amharic online, Ethiopia typing">
    <meta name="author" content="Ahmedhaji Sadik Umer">
    <meta name="robots" content="index, follow">
    <meta name="theme-color" content="#ffffff">

    <meta property="og:type" content="website">
    <meta property="og:url" content="https://amkb.vercel.app/">
    <meta property="og:title" content="Online Amharic Keyboard (የአማርኛ ኪቦርድ) - Type Amharic Easily">
    <meta property="og:description" content="Free online Amharic Fidel keyboard for easy typing in your browser. Supports physical keyboard and virtual key clicks.">
    <meta property="og:image" content="https://amkb.vercel.app/og-image.png">
    <meta property="og:locale" content="am_ET">

    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://amkb.vercel.app/">
    <meta property="twitter:title" content="Online Amharic Keyboard (የአማርኛ ኪቦርድ) - Type Amharic Easily">
    <meta property="twitter:description" content="Free online Amharic Fidel keyboard for easy typing in your browser. Supports physical keyboard and virtual key clicks.">
    <meta property="twitter:image" content="https://amkb.vercel.app/og-image.png"> <link rel="icon" href="/favicon.ico" sizes="any">
    <link rel="icon" href="/favicon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <link rel="manifest" href="/site.webmanifest">
    <meta name="google-site-verification" content="FzjlEWszFVraCefC57xc4mhuUwV5EK_tIIHNWTmzmis" />

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Ethiopic:wght@400;700&display=swap" rel="stylesheet">

    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebSite",
      "name": "Online Amharic Keyboard (የአማርኛ ኪቦርድ)",
      "url": "https://amkb.vercel.app/",
      "description": "A free and easy-to-use online Amharic keyboard (Fidel keyboard) to type Amharic letters and characters directly in your browser.",
      "keywords": "Amharic keyboard, online Amharic keyboard, Fidel keyboard, type Amharic, አማርኛ ኪቦርድ, Ethiopian keyboard, Geez keyboard, free Amharic typing",
      "inLanguage": "am",
      "author": {
        "@type": "Person",
        "name": "Ahmedhaji Sadik Umer"
      },
      "potentialAction": {
        "@type": "SearchAction",
        "target": {
          "@type": "EntryPoint",
          "urlTemplate": "https://amkb.vercel.app/?s={search_term_string}"
        },
        "query-input": "required name=search_term_string"
      }
    }
    </script>

    <style>
        /* style.css - Consider moving this to an external style.css file for caching */
        body {
            font-family: 'Noto Sans Ethiopic', 'Nyala', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            background-color: #f4f4f4;
            margin: 0;
            min-height: 100vh;
            box-sizing: border-box;
            color: #333; /* Default text color */
        }

        header {
            width: 100%;
            text-align: center;
            margin-bottom: 20px;
        }

        h1 {
            color: #333;
            margin-bottom: 0;
            text-align: center;
            margin-top: 0;
            font-size: 1.8em;
        }

        .main-layout {
            display: flex;
            flex-direction: row; /* Default for larger screens */
            gap: 20px;
            width: 95%;
            max-width: 1200px;
            align-items: flex-start;
            margin: 0 auto; /* Center the layout */
        }
        
        #keyboard-app {
            display: flex;
            flex-direction: column;
            flex: 1 1 550px; /* Allow keyboard app area to grow and shrink */
            max-width: 700px; /* Max width for keyboard area */
        }

        #keyboard-container {
            background-color: #e0e0e0;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-self: stretch; /* Ensure it stretches if parent allows */
            margin-top: 15px; /* Added spacing between textarea and keyboard */
        }

        textarea#output { /* More specific selector */
            padding: 15px;
            font-size: 1.5em;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-family: inherit;
            flex: 1 1 45%; /* Grow and shrink relative to main-layout */
            min-height: 250px; /* Default minimum height */
            box-sizing: border-box;
            resize: vertical;
            background-color: #fff;
            color: #333;
            /* No margin-bottom here, rely on gap from main-layout if it's a sibling, or flex order */
        }

        .keyboard-row {
            display: flex;
            justify-content: center;
            flex-wrap: nowrap; /* Prevent wrapping for consistent rows */
            gap: 6px;
            min-height: 45px; /* Minimum height for rows */
        }

        .key {
            padding: 10px 15px;
            font-size: 1.2em;
            flex: 1; /* Allow keys to grow and shrink evenly */
            text-align: center;
            background-color: #fff;
            border: 1px solid #ccc;
            border-bottom-width: 3px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s, box-shadow 0.2s, transform 0.1s;
            font-family: inherit;
            user-select: none; /* Prevent text selection on keys */
            display: flex;
            justify-content: center;
            align-items: center;
            min-width: 30px; /* Minimum width to prevent keys from becoming too small */
            color: #333;
        }

        .key:hover {
            background-color: #f0f0f0;
        }

        .key:active {
            background-color: #dcdcdc;
            border-bottom-width: 1px;
            transform: translateY(2px);
        }

        /* Special keys styling */
        .key[data-key="Backspace"], .key[data-key="Enter"] {
            flex-grow: 1.5; /* Make them slightly wider */
            font-size: 0.9em;
        }
        .key[data-key="Space"] {
            flex-grow: 8; /* Make space bar significantly wider */
        }

        #variation-keys {
            background-color: #f8f8f8;
            padding: 5px;
            border-radius: 5px;
            margin-bottom: 5px;
            min-height: 40px; /* Ensure it has height even when populated */
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        #variation-keys:empty {
            display: none; /* Hide if no variations */
        }
        
        #variation-keys .key { /* Style for keys within variation container */
            font-size: 1em; /* Slightly smaller for variations */
            padding: 8px 10px;
            flex-grow: 0;
            flex-shrink: 0;
        }


        .keyboard-info {
            width: 100%;
            margin-top: 20px;
            text-align: left;
            font-size: 1em;
            color: #333;
            background-color: #fffacd;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e0c240;
            line-height: 1.6;
            box-sizing: border-box;
        }
        .keyboard-info h2 {
            margin-top: 0;
            font-size: 1.2em;
            color: #000;
        }
        .keyboard-info strong {
            color: #000;
        }
        .keyboard-info code {
            background-color: #e0e0e0;
            padding: 2px 5px;
            border-radius: 3px;
            font-family: 'Courier New', Courier, monospace;
        }

        footer {
            margin-top: 25px;
            padding: 15px 10px;
            text-align: center;
            font-size: 0.9em;
            color: #555;
            width: 100%;
            background-color: #e9e9e9;
            border-top: 1px solid #ddd;
            box-sizing: border-box;
        }
        footer p {
            margin: 5px 0;
        }

        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            body { padding: 10px; }
            h1 { font-size: 1.5em; }
            .main-layout {
                flex-direction: column;
                width: 100%;
                gap: 15px;
            }
            #keyboard-app, textarea#output {
                flex-basis: auto;
                width: 100%;
                max-width: 100%;
                align-self: auto;
            }
            textarea#output {
                min-height: 150px;
                font-size: 1.3em;
            }
            #keyboard-container {
                margin-top: 0; /* Remove top margin when stacked */
            }
            .key {
                padding: 8px 10px;
                font-size: 1em;
                min-height: 40px;
            }
            #variation-keys .key {
                font-size: 0.9em;
                padding: 6px 8px;
            }
            .keyboard-info {
                font-size: 0.9em;
                margin-top: 15px;
            }
        }

        @media (max-width: 480px) {
            h1 { font-size: 1.3em; }
            .key {
                font-size: 0.9em;
                padding: 6px 5px;
                min-width: 20px;
            }
            #variation-keys .key {
                font-size: 0.8em;
                padding: 5px 6px;
            }
            textarea#output {
                min-height: 120px;
                font-size: 1.2em;
            }
            .keyboard-info {
                font-size: 0.85em;
                padding: 10px;
            }
            .keyboard-row {
                gap: 4px;
            }
            .key[data-key="Backspace"], .key[data-key="Enter"] {
                font-size: 0.7em;
            }
        }
    </style>
</head>
<body>

    <header>
        <h1>Online Amharic Keyboard (የአማርኛ ኪቦርድ)</h1>
    </header>

    <main class="main-layout">
        <section id="keyboard-app" aria-labelledby="keyboard-heading">
            <h2 id="keyboard-heading" class="visually-hidden">Amharic Typing Area</h2>
            <div id="keyboard-container" role="application" aria-roledescription="Amharic virtual keyboard">
                <div id="variation-keys" class="keyboard-row" aria-label="Character variations">
                    </div>
                </div>
        </section>
        <textarea id="output" rows="8" placeholder="Type Amharic here... (እዚህ አማርኛ ይጻፉ...)" aria-label="Amharic text input area" lang="am"></textarea>
    </main>
    <section class="keyboard-info" aria-labelledby="keyboard-instructions-heading">
        <h2 id="keyboard-instructions-heading">How to Use your physical keyboard</h2>
        <p><strong>ይህን ኪቦርድ የሰራሁት በዋናነት ለኮምፒዩተር እና ላፕቶፕ ተጠቃሚዎች ነው!፡ ኪቦርዱ በትክክል እንዲሰራ ፈጠን ብሎ መፃፍ ያስፈልጋል! አንድ ኮንሶናንት ኪይ ከተጫናችሁ በሗላ ወዲያው ቫውሉን መጫን አለባችሁ መዘግየት አያስፈልግም!። ለምሳሌ ልዩ ፊደሎችን እንደ ሸ፣ ፅ፣ ጸ፤ ጨ እና ሌሎችንም ተመሳሳይ ፊደሎችን ለመፃፍ ከታች ያስቀመጥኩትን የኪቦርድ ህግ ተከተሉ!</strong><br>
        Type a consonant (like <code>b</code>) followed by a vowel (<code>e, u, i, a, y, o</code>) to get different forms: <code>be</code> &rarr; በ, <code>bu</code> &rarr; ቡ, <code>bi</code> &rarr; ቢ, <code>ba</code> &rarr; ባ, <code>by</code> &rarr; ቤ, <code>bo</code> &rarr; ቦ.<br>
        Press a consonant key once to get the 6th form (e.g., <code>b</code> &rarr; ብ). For labialized forms, type 'wa' after the consonant (e.g., <code>bwa</code> &rarr; ቧ).
        </p>
        <p><strong>Special Characters:</strong><br>
        <code>h</code> &rarr; ሀ, <code>H</code> (Shift+h) &rarr; ሐ | <code>s</code> &rarr; ሰ, <code>S</code> (Shift+s) &rarr; ሠ | <code>t</code> &rarr; ተ, <code>T</code> (Shift+t) &rarr; ጠ | <code>c</code> &rarr; ቸ, <code>C</code> (Shift+c) &rarr; ጨ | <code>n</code> &rarr; ነ, <code>N</code> (Shift+n) &rarr; ኘ | <code>z</code> &rarr; ዘ, <code>Z</code> (Shift+z) &rarr; ዠ | <code>.</code> &rarr; ። | <code>,</code> &rarr; ፣ | Shift+. &rarr; ፀ | Shift+, &rarr; ጸ
        | <code>L</code> (Shift+l) &rarr; ሸ, <code>`</code> &rarr; ኀ, <code>~</code> &rarr; ኧ
        </p>
    </section>

    <footer>
        <p>Developed by: Ahmedhaji Sadik Umer | Contact: +251945033132</p>
        <p>&copy; <span id="currentYear"></span> Online Amharic Keyboard. All rights reserved.</p>
    </footer>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const outputTextarea = document.getElementById('output');
        const keyboardContainer = document.getElementById('keyboard-container');
        const variationKeysContainer = document.getElementById('variation-keys');

        const fidelGroups = {
            'ሀ': ['ሀ', 'ሁ', 'ሂ', 'ሃ', 'ሄ', 'ህ', 'ሆ', 'ኋ'], 'ለ': ['ለ', 'ሉ', 'ሊ', 'ላ', 'ሌ', 'ል', 'ሎ', 'ሏ'],
            'ሐ': ['ሐ', 'ሑ', 'ሒ', 'ሓ', 'ሔ', 'ሕ', 'ሖ', 'ሗ'], 'መ': ['መ', 'ሙ', 'ሚ', 'ማ', 'ሜ', 'ም', 'ሞ', 'ሟ'],
            'ሠ': ['ሠ', 'ሡ', 'ሢ', 'ሣ', 'ሤ', 'ሥ', 'ሦ', 'ሧ'], 'ረ': ['ረ', 'ሩ', 'ሪ', 'ራ', 'ሬ', 'ር', 'ሮ', 'ሯ'],
            'ሰ': ['ሰ', 'ሱ', 'ሲ', 'ሳ', 'ሴ', 'ስ', 'ሶ', 'ሷ'], 'ሸ': ['ሸ', 'ሹ', 'ሺ', 'ሻ', 'ሼ', 'ሽ', 'ሾ', 'ሿ'],
            'ቀ': ['ቀ', 'ቁ', 'ቂ', 'ቃ', 'ቄ', 'ቅ', 'ቆ', 'ቋ'], 'በ': ['በ', 'ቡ', 'ቢ', 'ባ', 'ቤ', 'ብ', 'ቦ', 'ቧ'],
            'ቨ': ['ቨ', 'ቩ', 'ቪ', 'ቫ', 'ቬ', 'ቭ', 'ቮ', 'ቯ'], 'ተ': ['ተ', 'ቱ', 'ቲ', 'ታ', 'ቴ', 'ት', 'ቶ', 'ቷ'],
            'ቸ': ['ቸ', 'ቹ', 'ቺ', 'ቻ', 'ቼ', 'ች', 'ቾ', 'ቿ'], 'ኀ': ['ኀ', 'ኁ', 'ኂ', 'ኃ', 'ኄ', 'ኅ', 'ኆ', 'ኋ'],
            'ነ': ['ነ', 'ኑ', 'ኒ', 'ና', 'ኔ', 'ን', 'ኖ', 'ኗ'], 'ኘ': ['ኘ', 'ኙ', 'ኚ', 'ኛ', 'ኜ', 'ኝ', 'ኞ', 'ኟ'],
            'አ': ['አ', 'ኡ', 'ኢ', 'ኣ', 'ኤ', 'እ', 'ኦ', 'ኧ'], 'ከ': ['ከ', 'ኩ', 'ኪ', 'ካ', 'ኬ', 'ክ', 'ኮ', 'ኳ'],
            'ኸ': ['ኸ', 'ኹ', 'ኺ', 'ኻ', 'ኼ', 'ኽ', 'ኾ', 'ዃ'], 'ወ': ['ወ', 'ዉ', 'ዊ', 'ዋ', 'ዌ', 'ው', 'ዎ'],
            'ዐ': ['ዐ', 'ዑ', 'ዒ', 'ዓ', 'ዔ', 'ዕ', 'ዖ'], 'ዘ': ['ዘ', 'ዙ', 'ዚ', 'ዛ', 'ዜ', 'ዝ', 'ዞ', 'ዟ'],
            'ዠ': ['ዠ', 'ዡ', 'ዢ', 'ዣ', 'ዤ', 'ዥ', 'ዦ', 'ዧ'], 'የ': ['የ', 'ዩ', 'ዪ', 'ያ', 'ዬ', 'ይ', 'ዮ'],
            'ደ': ['ደ', 'ዱ', 'ዲ', 'ዳ', 'ዴ', 'ድ', 'ዶ', 'ዷ'], 'ጀ': ['ጀ', 'ጁ', 'ጂ', 'ጃ', 'ጄ', 'ጅ', 'ጆ', 'ጇ'],
            'ገ': ['ገ', 'ጉ', 'ጊ', 'ጋ', 'ጌ', 'ግ', 'ጎ', 'ጓ'], 'ጠ': ['ጠ', 'ጡ', 'ጢ', 'ጣ', 'ጤ', 'ጥ', 'ጦ', 'ጧ'],
            'ጨ': ['ጨ', 'ጩ', 'ጪ', 'ጫ', 'ጬ', 'ጭ', 'ጮ', 'ጯ'], 'ጰ': ['ጰ', 'ጱ', 'ጲ', 'ጳ', 'ጴ', 'ጵ', 'ጶ', 'ጷ'],
            'ጸ': ['ጸ', 'ጹ', 'ጺ', 'ጻ', 'ጼ', 'ጽ', 'ጾ', 'ጿ'], 'ፀ': ['ፀ', 'ፁ', 'ፂ', 'ፃ', 'ፄ', 'ፅ', 'ፆ'],
            'ፈ': ['ፈ', 'ፉ', 'ፊ', 'ፋ', 'ፌ', 'ፍ', 'ፎ', 'ፏ'], 'ፐ': ['ፐ', 'ፑ', 'ፒ', 'ፓ', 'ፔ', 'ፕ', 'ፖ']
        };

        const physicalKeyMapping = {
            'h': 'ሀ', 'l': 'ለ', 'm': 'መ', 'r': 'ረ', 's': 'ሰ', 'q': 'ቀ', 'b': 'በ',
            't': 'ተ', 'c': 'ቸ', 'n': 'ነ', 'x': 'አ', 'k': 'ከ', 'w': 'ወ', 'z': 'ዘ',
            'y': 'የ', 'd': 'ደ', 'j': 'ጀ', 'g': 'ገ', 'f': 'ፈ', 'p': 'ፐ', 'v': 'ቨ',
            'H': 'ሐ', 'S': 'ሠ', 'T': 'ጠ', 'C': 'ጨ', 'N': 'ኘ', 'K': 'ኸ', 'Z': 'ዠ',
            'V': 'ኀ', 'P': 'ጰ', 'X': 'ዐ',
            '`': 'ኀ',  '~': 'ኧ', ',': '፣', '.': '።', ';': '፤', ':': '፡', '?': '?',
            '<': 'ፀ', '>': 'ጸ',  'L': 'ሸ',

            // Added requested symbols
            '/': '/',  // Forward slash
            '"': '"',  // Double quote

            // Added default symbols
            '1': '1', '2': '2', '3': '3', '4': '4', '5': '5', '6': '6', '7': '7', '8': '8', '9': '9', '0': '0',
            '-': '-', '=': '=',
            '!': '!', '@': '@', '#': '#', '$': '$', '%': '%', '^': '^', '&': '&', '*': '*', '(': '(', ')': ')',
            '_': '_', '+': '+'
        };

        const vowelMapping = { 'e': 0, 'u': 1, 'i': 2, 'a': 3, 'y': 4, 'o': 6 };

        let keySequence = '';
        let sequenceTimer = null;
        const SEQUENCE_TIMEOUT = 800; // Reduced timeout for responsiveness

        const keyboardLayout = [
            Object.keys(fidelGroups).slice(0, 10),
            Object.keys(fidelGroups).slice(10, 20),
            Object.keys(fidelGroups).slice(20, 30),
            Object.keys(fidelGroups).slice(30),
            ['@', '#', '፦', '፥', '፧', '፨', 'ኀ', 'ኧ'], // Punctuation row
            ['Backspace', 'Space', 'Enter']
        ];

        function insertAtCursor(textToInsert) {
            const startPos = outputTextarea.selectionStart;
            const endPos = outputTextarea.selectionEnd;
            const currentVal = outputTextarea.value;
            outputTextarea.value = currentVal.substring(0, startPos) + textToInsert + currentVal.substring(endPos);
            const newCursorPos = startPos + textToInsert.length;
            outputTextarea.selectionStart = outputTextarea.selectionEnd = newCursorPos;
            outputTextarea.focus();
        }

        function processSpecialKey(keyType) {
            const selectionStart = outputTextarea.selectionStart;
            const selectionEnd = outputTextarea.selectionEnd;

            switch (keyType) {
                case 'Backspace':
                    if (selectionStart === selectionEnd && selectionStart > 0) {
                        outputTextarea.value = outputTextarea.value.slice(0, selectionStart - 1) + outputTextarea.value.slice(selectionEnd);
                        outputTextarea.selectionStart = outputTextarea.selectionEnd = selectionStart - 1;
                    } else if (selectionStart !== selectionEnd) {
                        outputTextarea.value = outputTextarea.value.slice(0, selectionStart) + outputTextarea.value.slice(selectionEnd);
                        outputTextarea.selectionStart = outputTextarea.selectionEnd = selectionStart;
                    }
                    break;
                case 'Space': insertAtCursor(' '); break;
                case 'Enter': insertAtCursor('\n'); break;
            }
        }

        function clearSequence(resolve = false) {
            if (sequenceTimer) clearTimeout(sequenceTimer);
            sequenceTimer = null;
            if (resolve && keySequence) {
                // If a consonant was pending and no vowel followed, insert its 6th form
                const baseChar = physicalKeyMapping[keySequence];
                if (baseChar && fidelGroups[baseChar] && fidelGroups[baseChar][5]) {
                    insertAtCursor(fidelGroups[baseChar][5]);
                } else if (physicalKeyMapping[keySequence]) { // For single direct mapped characters like '.'
                    insertAtCursor(physicalKeyMapping[keySequence]);
                }
            }
            keySequence = '';
            variationKeysContainer.innerHTML = ''; // Clear variations when sequence is fully resolved/cleared
        }

        function displayVariations(baseFidel) {
            const variations = fidelGroups[baseFidel];
            variationKeysContainer.innerHTML = ''; // Clear previous variations
            if (!variations) {
                // If it's a base key with no variations (e.g., some punctuation), hide variations
                return;
            }

            const fragment = document.createDocumentFragment();
            variations.forEach(variation => {
                const keyElement = document.createElement('button');
                keyElement.textContent = variation;
                keyElement.classList.add('key');
                keyElement.dataset.key = variation;
                keyElement.setAttribute('role', 'button');
                keyElement.setAttribute('aria-label', `Amharic character variation ${variation}`);
                fragment.appendChild(keyElement);
            });
            variationKeysContainer.appendChild(fragment);
        }

        function handleVirtualKeyboardClick(event) {
            const keyElement = event.target.closest('.key');
            if (!keyElement) return;

            clearSequence(); // Clear any pending physical keyboard sequence
            const key = keyElement.dataset.key;

            if (key === 'Backspace' || key === 'Space' || key === 'Enter') {
                processSpecialKey(key);
                variationKeysContainer.innerHTML = ''; // Clear variations on special key press
            } else if (fidelGroups[key]) { // Is it a base character that has variations?
                // For virtual keyboard, directly insert the 6th form (default consonant)
                // and then display variations for further selection.
                insertAtCursor(fidelGroups[key][5]); // Insert the 6th form by default
                displayVariations(key);
            } else { // It's a variation key or a direct punctuation from the main layout
                insertAtCursor(key);
                variationKeysContainer.innerHTML = ''; // Clear variations after selection
            }
        }

        function handlePhysicalKeyboardDown(event) {
            // Allow common shortcuts
            if (event.ctrlKey || event.altKey || event.metaKey) {
                if (!['c', 'v', 'a', 'x', 'z', 'y', 'f'].includes(event.key.toLowerCase())) { // allow common shortcuts
                    clearSequence(true); // Resolve any pending sequence if a non-typing shortcut is used
                }
                return;
            }
            
            if (event.key === 'Tab') {
                clearSequence(true); // Resolve pending sequence before allowing tab behavior
                return;
            }

            const key = event.key;

            if (key === 'Backspace' || key === 'Enter' || key === ' ') {
                event.preventDefault(); // Prevent default browser action for these keys
                clearSequence(true); // Resolve pending sequence first
                processSpecialKey(key === ' ' ? 'Space' : key);
                variationKeysContainer.innerHTML = '';
                return;
            }
            
            // Ignore non-character keys (e.g., F1, Arrow keys, etc.) unless they are modifiers like Shift
            if (key.length > 1 && key !== 'Shift' && key !== 'Meta' && key !== 'Alt' && key !== 'Control') {
                clearSequence(true);
                return;
            }
            if (key === 'Shift' || key === 'Meta' || key === 'Alt' || key === 'Control') return; // Shift is a modifier, not a character

            event.preventDefault(); // Prevent default typing behavior for handled keys
            if (sequenceTimer) clearTimeout(sequenceTimer);

            // Case 1: Vowel follows a consonant (e.g., 'ba')
            // Special handling for 'wa' as labialized form
            if (keySequence.length === 1 && key.toLowerCase() === 'w') {
                keySequence += key.toLowerCase(); // Sequence is now like 'bw'
                sequenceTimer = setTimeout(() => clearSequence(true), SEQUENCE_TIMEOUT);
                return;
            }

            if (keySequence.length === 2 && keySequence.endsWith('w') && key.toLowerCase() === 'a') {
                const consonant = keySequence.slice(0, -1);
                const baseFidel = physicalKeyMapping[consonant];
                const variations = fidelGroups[baseFidel];
                if (variations && variations.length > 7 && variations[7]) { // Labialized is typically the 8th form (index 7)
                    insertAtCursor(variations[7]);
                    clearSequence(); // Clear sequence immediately after insertion
                } else {
                    // If no labialized form, treat as consonant + w + a (e.g., "ሰዋ")
                    insertAtCursor(physicalKeyMapping[consonant] + 'ዋ'); // Or whatever the logic for 'wa' should be if not labialized
                    clearSequence();
                }
                return;
            }

            // Normal consonant + vowel (e.g., 'be', 'bi')
            if (keySequence.length === 1 && physicalKeyMapping[keySequence] && vowelMapping.hasOwnProperty(key.toLowerCase())) {
                const baseFidel = physicalKeyMapping[keySequence];
                const variations = fidelGroups[baseFidel];
                const vowelIndex = vowelMapping[key.toLowerCase()];
                if (variations && variations[vowelIndex]) {
                    insertAtCursor(variations[vowelIndex]);
                } else {
                    // Fallback: if no direct mapping, insert consonant + vowel
                    insertAtCursor(baseFidel + key.toLowerCase());
                }
                clearSequence(); // Clear sequence immediately after insertion
                return;
            }

            // Case 2: The key itself is a direct mapping (e.g., '.', ',') or a new consonant
            clearSequence(true); // Resolve previous consonant if any, then process new key

            const mappedChar = physicalKeyMapping[key];
            if (mappedChar) {
                if (fidelGroups[mappedChar]) { // It's a consonant
                    keySequence = key; // Store the original key pressed (e.g. 'h' or 'H')
                    displayVariations(mappedChar);
                    sequenceTimer = setTimeout(() => {
                        clearSequence(true); // Resolve to 6th form if no vowel follows
                    }, SEQUENCE_TIMEOUT);
                } else { // It's direct punctuation, number, or other symbol
                    insertAtCursor(mappedChar);
                    clearSequence(); // Clear sequence as it's a standalone character
                }
            } else {
                // If it's an unmapped key, just clear the sequence.
                clearSequence();
            }
        }

        function init() {
            const baseKeysFragment = document.createDocumentFragment();
            keyboardLayout.forEach(row => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'keyboard-row';
                row.forEach(keyChar => {
                    const keyElement = document.createElement('button');
                    keyElement.textContent = keyChar;
                    keyElement.classList.add('key');
                    keyElement.dataset.key = keyChar;
                    keyElement.setAttribute('role', 'button');

                    let ariaLabelText = keyChar;
                    if (fidelGroups[keyChar]) {
                        ariaLabelText = `Amharic letter ${keyChar}`;
                    } else if (keyChar === 'Backspace' || keyChar === 'Space' || keyChar === 'Enter') {
                        ariaLabelText = keyChar;
                    } else {
                        ariaLabelText = `Character ${keyChar}`;
                    }
                    keyElement.setAttribute('aria-label', ariaLabelText);
                    rowDiv.appendChild(keyElement);
                });
                baseKeysFragment.appendChild(rowDiv);
            });
            // Append the generated keyboard rows to the keyboardContainer
            keyboardContainer.appendChild(baseKeysFragment);


            keyboardContainer.addEventListener('click', handleVirtualKeyboardClick);
            outputTextarea.addEventListener('keydown', handlePhysicalKeyboardDown);

            document.addEventListener('click', (event) => {
                // Clear variations and sequence if click is outside textarea or keyboard
                if (!keyboardContainer.contains(event.target) && event.target !== outputTextarea && !variationKeysContainer.contains(event.target)) {
                    clearSequence(true); // Resolve pending sequence and clear variations
                }
            });

            document.getElementById('currentYear').textContent = new Date().getFullYear();
        }

        init();
    });
    </script>
</body>
</html>
